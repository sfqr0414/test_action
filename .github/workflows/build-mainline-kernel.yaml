name: Build Mainline Kernel 6.19+

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Free Disk Space
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift
          
      - name: Install dependencies
        run: |
          sudo apt update
          # 补充了 libdw-dev 和确保 libssl-dev 存在
          # 同时也加上了交叉编译 Debian 包需要的常用工具
          sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev \
            ccache git dwarves libncurses-dev crossbuild-essential-arm64 \
            kmod xz-utils rsync debhelper config-package-dev curl libdw-dev

      - name: Clone Linux Kernel Source (v6.19+)
        run: |
          git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git linux-source

      - name: Configure Kernel
        working-directory: ./linux-source
        run: |
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
          ./scripts/config --enable CONFIG_DRM_ACCEL_ROCKET
          ./scripts/config --enable CONFIG_MODVERSIONS
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          ./scripts/config --set-str CONFIG_LOCALVERSION "-rockchip-mainline"
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

      - name: Build Debian Packages
        working-directory: ./linux-source
        run: |
          # 关键修改：添加 -d 标志给 dpkg-buildpackage 绕过严格的宿主机依赖检查
          # 或者通过环境变量让 deb-pkg 知道我们在交叉编译
          export KBUILD_BUILD_USER=runner
          export KBUILD_BUILD_HOST=github-actions
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
            -j$(nproc) bindeb-pkg \
            KDEB_PKGVERSION=$(date +%Y%m%d)-custom \
            KDEB_COMPRESS=xz \
            BINDEB_HOST_PROGS=1

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel-6.19-plus
          path: ./*.deb
          retention-days: 0
