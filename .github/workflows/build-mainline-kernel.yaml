name: Build Pure Mainline Kernel 6.19+ (Docker Ubuntu 25.10)

on:
  workflow_dispatch:
    inputs:
      ubuntu-version:
        description: 'Target Ubuntu version (e.g., 25.10)'
        required: true
        default: '25.10'
        type: string

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Pre-check Expected GCC Version
        id: gcc-check
        run: |
          UBUNTU_VERSION="${{ github.event.inputs.ubuntu-version }}"
          # 同样需要在预查时指定 platform
          EXPECTED_GCC_VERSION=$(docker run --rm --platform linux/arm64 --entrypoint /bin/bash \
            -e DEBIAN_FRONTEND=noninteractive \
            ubuntu:"${UBUNTU_VERSION}" -c "
            apt-get update -qq >/dev/null && 
            apt-get install -qq --no-install-recommends gcc -y >/dev/null && 
            gcc --version | head -1 | awk '{print \$4}' | sed 's/)//'
          ")
          echo "expected_gcc=${EXPECTED_GCC_VERSION}" >> $GITHUB_OUTPUT

      - name: Clone Linux Kernel Source (v6.19+)
        run: |
          git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git linux-source

      - name: Create Build Script
        run: |
          cat << 'EOF' > build_script.sh
          set -e
          apt-get update -qq
          apt-get install -qq -y \
            build-essential bc bison flex libssl-dev libelf-dev \
            ccache git dwarves libncurses-dev kmod xz-utils rsync \
            debhelper config-package-dev curl libdw-dev \
            python3-minimal python3-dev libcap-dev debianutils \
            fakeroot kmod

          ACTUAL_GCC=$(gcc --version | head -1 | awk '{print $4}' | sed 's/)//')
          if [ "$ACTUAL_GCC" != "$EXPECTED_GCC" ]; then
            echo "ABI Mismatch! Actual: $ACTUAL_GCC, Expected: $EXPECTED_GCC"
            exit 1
          fi

          cd /workspace/linux-source
          curl -sLo .config https://raw.githubusercontent.com/armbian/build/main/config/kernel/linux-rockchip64-edge.config
          make olddefconfig
          ./scripts/config --enable CONFIG_DRM_ACCEL_ROCKET
          ./scripts/config --enable CONFIG_MODVERSIONS
          ./scripts/config --enable CONFIG_MODULE_SRCVERSION_ALL
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
          ./scripts/config --set-str CONFIG_LOCALVERSION "-rockchip-mainline"
          make olddefconfig

          export KBUILD_BUILD_USER=runner
          export KBUILD_BUILD_HOST=github-actions
          export DEB_BUILD_OPTIONS="nostrip nodbg"
          
          # 在 QEMU 模拟环境下，建议不要将核心数开得太满，防止 OOM
          make -j$(nproc) bindeb-pkg KDEB_PKGVERSION=$(date +%Y%m%d)-armbian-edge KDEB_COMPRESS=xz
          EOF
          chmod +x build_script.sh

      - name: Run Build in Docker
        run: |
          # 关键点：添加 --platform linux/arm64 解决架构匹配问题
          docker run --rm --privileged \
            --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e EXPECTED_GCC="${{ steps.gcc-check.outputs.expected_gcc }}" \
            -e DEBIAN_FRONTEND=noninteractive \
            arm64v8/ubuntu:"${{ github.event.inputs.ubuntu-version }}" /bin/bash /workspace/build_script.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel-6.19-${{ github.event.inputs.ubuntu-version }}-pure
          path: ./*.deb
          retention-days: 90
