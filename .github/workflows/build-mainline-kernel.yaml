name: Build Mainline Kernel (OP5 Max 6.19 Hybrid-Master)

on:
  workflow_dispatch:
    inputs:
      ubuntu-version:
        description: 'Ubuntu Image Version'
        required: true
        default: '24.04'
      target_kernel_version:
        description: 'Kernel Version (e.g., 6.19-rc8)'
        required: true
        default: '6.19-rc8'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift

      - name: Check GCC Version on Host
        id: gcc-check
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq -y gcc-aarch64-linux-gnu
          echo "expected_gcc=$(aarch64-linux-gnu-gcc --version | head -1 | awk '{print $4}' | sed 's/)//')" >> $GITHUB_OUTPUT

      - name: Fetch Kernel Source (Tarball with Git Fallback)
        env:
          VERSION: ${{ github.event.inputs.target_kernel_version }}
        run: |
          # 清洗版本号，处理 rc 标签
          BASE_VERSION=$(echo $VERSION | cut -d- -f1)
          MAJOR=$(echo $BASE_VERSION | cut -d. -f1)
          URL="https://www.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${VERSION}.tar.xz"
          
          echo "Step 1: 尝试探测 Tarball -> $URL"
          if wget -q --spider "$URL"; then
              echo "资源存在，开始高速下载 Tarball..."
              wget -q -O src.tar.xz "$URL"
              mkdir -p linux-source
              tar -xJf src.tar.xz -C linux-source --strip-components=1
              rm src.tar.xz
          else
              echo "Step 1 失败，执行 Step 2: 浅克隆 Git 仓库 (v${VERSION})"
              TAG="v${VERSION}"
              git clone --depth 1 --branch "$TAG" https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-source || \
              {
                echo "未找到标签，尝试拉取 master"
                git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-source
              }
          fi

      - name: Create Build Script
        run: |
          cat << 'EOF' > build_script.sh
          set -e
          
          # 1. 安装基础依赖
          apt-get update -qq
          apt-get install -qq -y \
            build-essential bc bison flex libssl-dev libelf-dev \
            ccache git dwarves libncurses-dev kmod xz-utils rsync \
            debhelper config-package-dev curl libdw-dev \
            python3-minimal python3-dev libcap-dev debianutils \
            fakeroot gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

          # 2. 版本强校验
          ACTUAL_GCC=$(aarch64-linux-gnu-gcc --version | head -1 | awk '{print $4}' | sed 's/)//')
          if [ "$ACTUAL_GCC" != "$EXPECTED_GCC" ]; then
            echo "ABI Mismatch Error!"
            exit 1
          fi

          # 3. 内核配置阶段
          cd /workspace/linux-source
          
          # 使用 Armbian Edge 作为底座
          curl -sLo .config https://raw.githubusercontent.com/armbian/build/main/config/kernel/linux-rockchip64-edge.config
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 抹除源码自带的版本后缀干扰
          touch .scmversion
          
          make olddefconfig
          
          # --- [回归你确认成功的配置参数] ---
          ./scripts/config --enable CONFIG_DRM_ACCEL_ROCKET
          ./scripts/config --enable CONFIG_MODVERSIONS
          ./scripts/config --disable CONFIG_DEBUG_INFO
          ./scripts/config --disable CONFIG_DEBUG_INFO_BTF
          ./scripts/config --disable CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          
          # --- [EDK2/NVMe 启动保障：强制内置核心驱动] ---
          ./scripts/config --enable CONFIG_NVME_CORE
          ./scripts/config --enable CONFIG_BLK_DEV_NVME
          ./scripts/config --enable CONFIG_PCIE_ROCKCHIP_DW_HOST
          ./scripts/config --enable CONFIG_PHY_ROCKCHIP_NANENG_COMBO_PHY
          ./scripts/config --enable CONFIG_EFI_STUB
          
          # --- [回归你成功的名称定义，对齐路径] ---
          ./scripts/config --set-str CONFIG_LOCALVERSION "-rockchip-mainline"
          
          make olddefconfig

          # 4. 执行交叉编译并打包
          export KBUILD_BUILD_USER=runner
          export KBUILD_BUILD_HOST=github-actions
          export DEB_BUILD_OPTIONS="nostrip nodbg"
          
          make -j$(nproc) bindeb-pkg \
            ARCH=arm64 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            KDEB_PKGVERSION=$(date +%Y%m%d)-armbian-edge \
            KDEB_COMPRESS=xz \
            DPKG_FLAGS="-d"
          EOF
          chmod +x build_script.sh

      - name: Run Build in x86_64 Docker
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e EXPECTED_GCC="${{ steps.gcc-check.outputs.expected_gcc }}" \
            -e DEBIAN_FRONTEND=noninteractive \
            ubuntu:"${{ github.event.inputs.ubuntu-version }}" /bin/bash /workspace/build_script.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-op5max-6.19-final-fix
          path: ./*.deb
