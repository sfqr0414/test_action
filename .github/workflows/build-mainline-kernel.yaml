name: Build Mainline Kernel (OP5 Max 6.19 Hybrid)

on:
  workflow_dispatch:
    inputs:
      target_kernel_version:
        description: 'Kernel Version (e.g., 6.19)'
        required: true
        default: '6.19'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift

      - name: Fetch Kernel Source (Tarball with Git Fallback)
        env:
          VERSION: ${{ github.event.inputs.target_kernel_version }}
        run: |
          MAJOR=$(echo $VERSION | cut -d. -f1)
          URL="https://www.kernel.org/pub/linux/kernel/v${MAJOR}.x/linux-${VERSION}.tar.xz"
          
          echo "Step 1: 尝试探测 Tarball 资源 -> $URL"
          # 使用 --spider 探测，不下载
          if wget -q --spider "$URL"; then
              echo "资源存在，开始高速下载 Tarball..."
              wget -q -O src.tar.xz "$URL"
              mkdir -p linux-source
              tar -xJf src.tar.xz -C linux-source --strip-components=1
              rm src.tar.xz
          else
              echo "Step 1 失败 (资源未发布)，执行 Step 2: 浅克隆 Git 仓库 (v${VERSION})"
              # 如果正式版没出，Git 可能会报错找不到标签，所以加一个 fallback 到 master 或相关分支的逻辑
              TAG="v${VERSION}"
              git clone --depth 1 --branch "$TAG" https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-source || \
              {
                echo "警告: 未找到标签 $TAG，尝试克隆 master 分支 (包含最新 6.19 代码)"
                git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-source
              }
          fi

      - name: Create Build Script
        run: |
          cat << 'EOF' > build_script.sh
          set -e
          apt-get update -qq && apt-get install -qq -y build-essential bc bison flex libssl-dev libelf-dev ccache dwarves libncurses-dev rsync debhelper config-package-dev curl gcc-aarch64-linux-gnu git

          cd /workspace/linux-source
          # 拉取 Armbian 针对 RK3588 的主线配置基准
          curl -sLo .config https://raw.githubusercontent.com/armbian/build/main/config/kernel/linux-rockchip64-edge.config
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # --- [核心：GPU & HDMI 修复] ---
          ./scripts/config --enable CONFIG_DRM_PANTHOR
          ./scripts/config --enable CONFIG_PHY_ROCKCHIP_SAMSUNG_HDPTX
          ./scripts/config --enable CONFIG_DRM_ROCKCHIP_DW_HDMI_QP
          
          # --- [核心：Samba 响应优化] ---
          ./scripts/config --enable CONFIG_CIFS_SMB_DIRECT
          
          # --- [基础优化与名称简化] ---
          ./scripts/config --disable CONFIG_DEBUG_INFO
          # 仅保留 preview
          ./scripts/config --set-str CONFIG_LOCALVERSION "-preview"
          
          make olddefconfig
          make -j$(nproc) bindeb-pkg KDEB_PKGVERSION=$(date +%Y%m%d)
          EOF
          chmod +x build_script.sh

      - name: Run Build in Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace ubuntu:24.04 /bin/bash /workspace/build_script.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-op5max-6.19-preview
          path: ./*.deb
