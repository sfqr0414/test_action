name: Store Docker Image
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      # ğŸ”¥ å½»åº•åˆ é™¤ GHCR ä¸Šçš„ ubuntu-rockchip åŒ…ï¼ˆæ‰€æœ‰ç‰ˆæœ¬ + åŒ…æœ¬èº«ï¼‰
      - name: Delete entire ubuntu-rockchip package
        run: |
          USERNAME=${{ secrets.GHCR_USERNAME }}
          PACKAGE="ubuntu-rockchip"
          TOKEN=${{ secrets.GHCR_PAT }}

          echo "=== 1. åˆ é™¤ ubuntu-rockchip æ‰€æœ‰ç‰ˆæœ¬ï¼ˆåˆ†é¡µå…¨é‡åˆ é™¤ï¼‰==="
          PAGE=1
          while true; do
            VERSION_IDS=$(curl -s -L \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/users/$USERNAME/packages/container/$PACKAGE/versions?per_page=100&page=$PAGE" \
              | jq -r '.[].id')

            if [ -z "$VERSION_IDS" ] || [ "$VERSION_IDS" == "null" ]; then
              echo "âœ… æ‰€æœ‰ç‰ˆæœ¬å·²åˆ å®Œ"
              break
            fi

            for VID in $VERSION_IDS; do
              echo "ğŸ—‘ åˆ é™¤ç‰ˆæœ¬: $VID"
              curl -s -X DELETE \
                -H "Authorization: token $TOKEN" \
                "https://api.github.com/users/$USERNAME/packages/container/$PACKAGE/versions/$VID"
            done

            PAGE=$((PAGE+1))
          done

          echo "=== 2. åˆ é™¤æ•´ä¸ª ubuntu-rockchip åŒ…ï¼ˆé¡µé¢å½»åº•æ¶ˆå¤±ï¼‰==="
          curl -s -X DELETE \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/users/$USERNAME/packages/container/$PACKAGE"
          echo "âœ… ubuntu-rockchip åŒ…å·²å½»åº•åˆ é™¤"

      # æ‰¹é‡åŒæ­¥ Ubuntu 22.04 ~ 25.10 åˆ°æ–°çš„ ubuntu åŒ…
      - name: Mirror Ubuntu 22.04-25.10 to GHCR
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )

          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== åŒæ­¥ Ubuntu $VER ====="
            docker buildx imagetools create \
              --tag ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER \
              docker.io/library/ubuntu:$VER
            echo "âœ… å·²åŒæ­¥: ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER"
          done
            
      # æ¯ä¸ªç‰ˆæœ¬éƒ½æ‹‰å–éªŒè¯
      - name: Test pull all ubuntu images
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )
          
          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== æµ‹è¯•æ‹‰å– Ubuntu $VER ====="
            docker rmi ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER || true
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER
            echo "âœ… Ubuntu $VER æ‹‰å–æˆåŠŸ"
          done
