name: Store Docker Image
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      # 批量转存 Ubuntu 22.04 ~ 25.10
      - name: Mirror Ubuntu 22.04-25.10 to GHCR
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )

          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== Mirroring Ubuntu $VER ====="
            docker buildx imagetools create \
              --tag ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu-rockchip:$VER \
              docker.io/library/ubuntu:$VER
              echo "✅ Mirrored: ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu-rockchip:$VER"
          done
            
      # 每个版本都单独拉取验证一遍
      - name: Test pull all mirrored images
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )
          
          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== Testing pull Ubuntu $VER from GHCR ====="
            docker rmi ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu-rockchip:$VER || true
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu-rockchip:$VER
            echo "✅ Ubuntu $VER: pull OK"
          done
