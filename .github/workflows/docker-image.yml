name: Store Docker Image
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      # ğŸ”¥ å½»åº•åˆ é™¤ GHCR ä¸Šæ‰€æœ‰æ—§çš„ ubuntu-rockchip é•œåƒ
      - name: Delete all old ubuntu-rockchip images
        run: |
          USERNAME=${{ secrets.GHCR_USERNAME }}
          PACKAGE="ubuntu-rockchip"
          TOKEN=${{ secrets.GHCR_PAT }}

          # è·å–æ‰€æœ‰ç‰ˆæœ¬ ID
          VERSIONS=$(curl -s \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/users/$USERNAME/packages/container/$PACKAGE/versions \
            | jq -r '.[].id')

          if [ -z "$VERSIONS" ]; then
            echo "âœ… No old ubuntu-rockchip images found"
            exit 0
          fi

          # å¾ªç¯åˆ é™¤æ‰€æœ‰ç‰ˆæœ¬
          for VID in $VERSIONS; do
            echo "ğŸ—‘ Deleting old image version: $VID"
            curl -s -X DELETE \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/users/$USERNAME/packages/container/$PACKAGE/versions/$VID
          done
          echo "âœ… All old ubuntu-rockchip images deleted"

      # æ‰¹é‡åŒæ­¥ Ubuntu 22.04 ~ 25.10 åˆ°æ–°çš„ ubuntu ä»“åº“
      - name: Mirror Ubuntu 22.04-25.10 to GHCR (new ubuntu)
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )

          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== Mirroring Ubuntu $VER ====="
            docker buildx imagetools create \
              --tag ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER \
              docker.io/library/ubuntu:$VER
            echo "âœ… Mirrored: ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER"
          done
            
      # æ¯ä¸ªç‰ˆæœ¬éƒ½å•ç‹¬æ‹‰å–éªŒè¯ï¼Œç¡®ä¿æ–°é•œåƒå¯ç”¨
      - name: Test pull all new ubuntu images
        run: |
          UBUNTU_VERSIONS=(
            "22.04" "22.10" "23.04" "23.10"
            "24.04" "24.10" "25.04" "25.10"
          )
          
          for VER in "${UBUNTU_VERSIONS[@]}"; do
            echo "===== Testing pull Ubuntu $VER from GHCR ====="
            docker rmi ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER || true
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/ubuntu:$VER
            echo "âœ… Ubuntu $VER: pull OK"
          done
